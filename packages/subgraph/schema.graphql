# ──────────────────────────────────────────
# 0xSlots Subgraph Schema (core protocol only)
# ──────────────────────────────────────────

type Hub @entity(immutable: false) {
  id: ID! # SlotsHub address
  protocolFeeBps: BigInt!
  protocolFeeRecipient: Bytes!
  slotPrice: BigInt!
  defaultCurrency: Currency
  defaultSlotCount: BigInt!
  defaultPrice: BigInt!
  defaultTaxPercentage: BigInt!
  defaultMaxTaxPercentage: BigInt!
  defaultMinTaxUpdatePeriod: BigInt!
  defaultModule: Bytes!
  lands: [Land!]! @derivedFrom(field: "hub")
  allowedModules: [Module!]! @derivedFrom(field: "hub")
  allowedCurrencies: [Currency!]! @derivedFrom(field: "hub")
}

type Land @entity(immutable: false) {
  id: ID! # Slots contract address
  hub: Hub!
  owner: Bytes! # account that opened the land
  slots: [Slot!]! @derivedFrom(field: "land")
  createdAt: BigInt!
  createdTx: Bytes!
}

type Slot @entity(immutable: false) {
  id: ID! # land-slotId
  land: Land!
  slotId: BigInt!
  occupant: Bytes # current occupant (null = vacant)
  currency: Bytes!
  basePrice: BigInt!
  price: BigInt!
  taxPercentage: BigInt!
  maxTaxPercentage: BigInt!
  minTaxUpdatePeriod: BigInt!
  module: Bytes
  active: Boolean!
  createdAt: BigInt!
  updatedAt: BigInt!
  createdEvent: SlotCreatedEvent @derivedFrom(field: "slot")
  purchases: [SlotPurchase!]! @derivedFrom(field: "slot")
  releases: [SlotReleasedEvent!]! @derivedFrom(field: "slot")
  priceHistory: [PriceUpdate!]! @derivedFrom(field: "slot")
  taxUpdates: [TaxRateChange!]! @derivedFrom(field: "slot")
}

# ──────────────────────────────────────────
# Event Entities
# ──────────────────────────────────────────

type LandOpenedEvent @entity(immutable: true) {
  id: ID! # tx-logIndex
  land: Land!
  account: Bytes! # account that opened the land
  timestamp: BigInt!
  blockNumber: BigInt!
  tx: Bytes!
}

type SlotCreatedEvent @entity(immutable: true) {
  id: ID! # tx-logIndex
  slot: Slot!
  land: Bytes!
  slotId: BigInt!
  currency: Bytes!
  basePrice: BigInt!
  price: BigInt!
  taxPercentage: BigInt!
  timestamp: BigInt!
  blockNumber: BigInt!
  tx: Bytes!
}

type SlotPurchase @entity(immutable: true) {
  id: ID! # tx-logIndex
  slot: Slot!
  newOccupant: Bytes!
  previousOccupant: Bytes
  timestamp: BigInt!
  blockNumber: BigInt!
  tx: Bytes!
}

type SlotReleasedEvent @entity(immutable: true) {
  id: ID! # tx-logIndex
  slot: Slot!
  land: Bytes!
  slotId: BigInt!
  previousOccupant: Bytes
  timestamp: BigInt!
  blockNumber: BigInt!
  tx: Bytes!
}

type PriceUpdate @entity(immutable: true) {
  id: ID! # tx-logIndex
  slot: Slot!
  oldPrice: BigInt!
  newPrice: BigInt!
  timestamp: BigInt!
  blockNumber: BigInt!
  tx: Bytes!
}

type TaxRateChange @entity(immutable: true) {
  id: ID! # tx-logIndex
  slot: Slot!
  kind: String! # "proposed" | "confirmed" | "cancelled"
  oldPercentage: BigInt
  newPercentage: BigInt
  confirmableAt: BigInt
  timestamp: BigInt!
  blockNumber: BigInt!
  tx: Bytes!
}

type FlowChange @entity(immutable: true) {
  id: ID! # tx-logIndex
  from: Bytes!
  to: Bytes!
  oldRate: BigInt!
  newRate: BigInt!
  operation: String!
  timestamp: BigInt!
  blockNumber: BigInt!
  tx: Bytes!
}

type Module @entity(immutable: false) {
  id: ID! # module address
  hub: Hub!
  allowed: Boolean!
  name: String!
  version: String!
}

type Currency @entity(immutable: false) {
  id: ID! # currency address (SuperToken)
  hub: Hub!
  allowed: Boolean!
  name: String
  symbol: String
  decimals: Int
  underlyingToken: Bytes # address(0) = native wrapper, otherwise ERC-20
  underlyingName: String
  underlyingSymbol: String
  underlyingDecimals: Int
}
